using CodeBase.Data;
using CodeBase.Infrastructure.States;
<<<<<<< HEAD
using CodeBase.Services;
using CodeBase.Services.Ads;
using CodeBase.Services.Input;
=======
>>>>>>> origin/feature/yandex_leaderboard
using CodeBase.StaticData.Levels;
using CodeBase.UI.Services.Windows;
using CodeBase.UI.Windows.Common;
using Plugins.SoundInstance.Core.Static;
using UnityEngine;
using UnityEngine.UI;

namespace CodeBase.UI.Windows.Gifts
{
    public class GiftsWindow : WindowBase
    {
        [SerializeField] private Button _addCoinsButton;
        [SerializeField] private Button _toNextLevelButton;
        [SerializeField] private ItemsGeneratorBase _generator;
        [SerializeField] private int _coinsCount;

        private Scene _nextScene;
<<<<<<< HEAD
        private IAdsService _adsService;

        private void Awake()
        {
            _adsService = AllServices.Container.Single<IAdsService>();
            StartCoroutine(InitializeYandexSDK());
        }

        private void Start()
        {
            if (AllServices.Container.Single<IInputService>() is DesktopInputService)
                Cursor.lockState = CursorLockMode.Confined;
        }
=======
>>>>>>> origin/feature/yandex_leaderboard

        private void OnEnable()
        {
            _addCoinsButton.enabled = Application.isEditor;

            _addCoinsButton.onClick.AddListener(ShowAds);
<<<<<<< HEAD
            _toNextLevelButton.onClick.AddListener(ToNextLevel);
            _generator.GenerationStarted += DisableRefreshButtons;
            _adsService.OnRewardedClosed += AddCoins;
            _generator.GenerationEnded += CheckRefreshButtons;
=======
            Cursor.lockState = CursorLockMode.Confined;
            GenerateItems();

            if (Application.isEditor)
                return;

            if (AdsService == null)
                return;

            AdsService.OnInitializeSuccess += AdsServiceInitializedSuccess;
            AdsService.OnRewarded += AddCoins;
            AdsService.OnShowRewardedAdError += ShowError;
            AdsService.OnClosedRewarded += ShowClosed;
            InitializeAdsSDK();
>>>>>>> origin/feature/yandex_leaderboard
        }

        private void OnDisable()
        {
            _addCoinsButton.onClick.RemoveListener(ShowAds);
<<<<<<< HEAD
            _toNextLevelButton.onClick.RemoveListener(ToNextLevel);
            _adsService.OnRewardedClosed -= AddCoins;
            _generator.GenerationStarted -= DisableRefreshButtons;
            _generator.GenerationEnded -= CheckRefreshButtons;
=======

            if (AdsService == null)
                return;

            AdsService.OnInitializeSuccess -= AdsServiceInitializedSuccess;
            AdsService.OnRewarded -= AddCoins;
            AdsService.OnShowRewardedAdError -= ShowError;
            AdsService.OnClosedRewarded -= ShowClosed;
>>>>>>> origin/feature/yandex_leaderboard
        }

        public void Construct(GameObject hero) =>
            base.Construct(hero, WindowId.Gifts);

        public void AddData(Scene nextLevel)
        {
            _nextScene = nextLevel;
            _toNextLevelButton.onClick.AddListener(ToNextLevel);
        }

        protected override void AdsServiceInitializedSuccess() =>
            _addCoinsButton.enabled = true;

        private void ShowError(string message)
        {
            Debug.Log($"OnErrorRewarded: {message}");
            AddCoins();
        }

<<<<<<< HEAD
        private void DisableRefreshButtons()
        {
        }

        private void CheckRefreshButtons()
        {
        }
=======
        private void ShowClosed() =>
            Debug.Log("OnClosedRewarded");
>>>>>>> origin/feature/yandex_leaderboard

        private void ToNextLevel()
        {
            LevelStaticData levelStaticData = StaticDataService.ForLevel(_nextScene);
            Progress.WorldData.LevelNameData.ChangeLevel(_nextScene.ToString());
            Progress.Stats.StartNewLevel(_nextScene, levelStaticData.TargetPlayTime,
                levelStaticData.EnemySpawners.Count);
            SaveLoadService.SaveProgress();
            WindowService.HideAll();
            Close();
            GameStateMachine.Enter<LoadSceneState, Scene>(_nextScene);
        }

        private void Close() =>
            Hide();

        private void ShowAds()
        {
            if (Application.isEditor)
            {
                AddCoins();
                _addCoinsButton.gameObject.SetActive(false);
                return;
            }

            AdsService.ShowRewardedAd();
        }

        private void AddCoins()
        {
            Progress.Stats.AllMoney.AddMoney(_coinsCount);
            _addCoinsButton.gameObject.SetActive(false);
        }

        private void GenerateItems() =>
            _generator.Generate();

        protected override void PlayOpenSound()
        {
            SoundInstance.InstantiateOnTransform(
                audioClip: SoundInstance.GetClipFromLibrary(AudioClipAddresses.VictoryMusic), transform: transform,
                Volume, AudioSource);
            SoundInstance.StopRandomMusic(false);
        }
    }
}